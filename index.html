<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D é¡ä½å¤§å¸« - V13.2 ä¿®æ­£ç‰ˆ</title>
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body { margin: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #121212; color: white; }
        #canvas-container { width: 100vw; height: 100vh; display: block; position: absolute; top: 0; left: 0; z-index: 1; }

        /* --- ç¶ æ¡†èˆ‡è¼”åŠ©ç·š --- */
        #overlay-container {
            position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 2;
            display: flex; justify-content: center; align-items: center;
        }
        #aspect-frame {
            position: absolute;
            border: 2px solid #00ff00;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.85);
            display: flex; flex-wrap: wrap; pointer-events: none;
            transition: all 0.3s ease;
        }
        #grid-layer {
            width: 100%; height: 100%; display: none; flex-wrap: wrap;
        }
        .grid-cell { 
            width: 33.33%; height: 33.33%; box-sizing: border-box; 
            border: 1px solid rgba(255, 255, 255, 0.25);
        }
        
        /* --- POV åˆ‡æ›æŒ‰éˆ• --- */
        #pov-toggle-btn {
            position: absolute; top: 20px; right: 20px; z-index: 20;
            width: 50px; height: 50px; border-radius: 50%;
            background: rgba(40, 40, 40, 0.8); border: 2px solid #fff;
            color: #fff; font-size: 24px; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: transform 0.2s;
        }
        #pov-toggle-btn:active { transform: scale(0.9); }
        #pov-toggle-btn.active { background: #ff5252; border-color: #ff5252; box-shadow: 0 0 15px rgba(255, 82, 82, 0.6); }

        /* --- é¸å–®æŒ‰éˆ• --- */
        #open-menu-btn {
            position: absolute; top: 20px; left: 20px; z-index: 20;
            padding: 10px 16px; background: rgba(0,0,0,0.6); color: #fff;
            border: 1px solid #555; border-radius: 20px; font-size: 14px; cursor: pointer;
            backdrop-filter: blur(5px);
        }

        /* --- é¡é ­åˆ‡æ›åˆ— --- */
        #lens-bar {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            z-index: 20; display: flex; gap: 12px;
            background: rgba(0,0,0,0.8); padding: 10px 15px; border-radius: 30px;
            backdrop-filter: blur(10px); border: 1px solid #333;
        }
        .lens-btn {
            background: none; border: none; color: #888; font-size: 16px; font-weight: bold;
            cursor: pointer; padding: 8px 12px; border-radius: 20px; transition: all 0.2s;
            display: flex; flex-direction: column; align-items: center; gap: 2px;
        }
        .lens-btn span { font-size: 10px; font-weight: normal; opacity: 0.7; }
        .lens-btn.active { background: #fff; color: #000; box-shadow: 0 0 10px rgba(255,255,255,0.3); transform: translateY(-2px); }
        .lens-btn.macro-active { background: #ffeb3b; color: #000; }

        /* --- å´é‚Šé¢æ¿ --- */
        #ui-panel {
            position: absolute; top: 0; left: 0; width: 320px; height: 100vh;
            background: rgba(18, 18, 18, 0.98); z-index: 30;
            padding: 20px; box-sizing: border-box; transform: translateX(-100%); transition: transform 0.3s ease;
            overflow-y: auto; border-right: 1px solid #333;
        }
        #ui-panel.open { transform: translateX(0); }

        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        h2 { margin: 0; font-size: 22px; color: #ffca28; }
        #close-menu-btn { background: none; border: none; color: #fff; font-size: 28px; cursor: pointer; }

        .control-group { margin-bottom: 25px; }
        label { display: block; margin-bottom: 10px; font-size: 16px; color: #ccc; font-weight: bold; }
        select, textarea, input { width: 100%; padding: 14px; background: #2c2c2c; border: 1px solid #444; color: white; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        
        .toggle-btn { width: 100%; padding: 14px; background: #333; color: #aaa; border: 1px solid #444; border-radius: 8px; font-size: 16px; cursor: pointer; text-align: center; }
        .toggle-btn.active { background: #4caf50; color: white; border-color: #4caf50; }

        .btn-primary { width: 100%; padding: 16px; background: #ffca28; color: #000; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-copy { width: 100%; padding: 16px; background: #00e676; color: #000; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; display: none; }

        #result-area { margin-top: 20px; padding: 15px; background: #000; border: 1px solid #333; border-radius: 8px; min-height: 80px; font-size: 14px; line-height: 1.6; color: #ffeb3b; word-wrap: break-word; }

        @media (max-width: 600px) {
            #lens-bar { bottom: 20px; width: 90%; justify-content: space-around; }
            .lens-btn { font-size: 14px; }
            #ui-panel { width: 100%; }
        }

    </style>
    
    <script src="https://unpkg.com/three@0.126.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.126.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>
    <div id="canvas-container"></div>
    
    <div id="overlay-container">
        <div id="aspect-frame">
            <div id="grid-layer">
                <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
                <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
                <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
            </div>
        </div>
    </div>

    <button id="open-menu-btn">â˜° è¨­å®š</button>
    <button id="pov-toggle-btn" title="åˆ‡æ›ç¬¬ä¸€äººç¨± (POV)">ğŸ”„</button>

    <div id="lens-bar">
        <button class="lens-btn" data-lens="0.5">0.5x<span>å»£è§’</span></button>
        <button class="lens-btn active" data-lens="1">1x<span>æ¨™æº–</span></button>
        <button class="lens-btn" data-lens="3">3x<span>ç‰¹å¯«</span></button>
        <button class="lens-btn" data-lens="macro" style="color:#ffeb3b;">ğŸŒ·<span>å¾®è·</span></button>
    </div>

    <div id="ui-panel">
        <div class="panel-header">
            <h2>V13.2 é¡ä½å¤§å¸«</h2>
            <button id="close-menu-btn">Ã—</button>
        </div>
        <div class="control-group">
            <div class="toggle-btn" id="toggleGrid">ğŸ“… ä¹å®®æ ¼åƒè€ƒç·š</div>
        </div>
        <div class="control-group">
            <label>ç•«é¢æ¯”ä¾‹</label>
            <select id="aspectRatio">
                <option value="16:9" selected>16:9 (é›»å½±)</option>
                <option value="9:16">9:16 (Shorts/Reels)</option>
                <option value="4:3">4:3 (é›»è¦–)</option>
                <option value="1:1">1:1 (IG)</option>
                <option value="21:9">21:9 (è¶…å¯¬é›»å½±)</option>
            </select>
        </div>
        <div class="control-group">
            <label>é¢¨æ ¼ (Style)</label>
            <select id="style">
                <option value="Photorealistic, 8k, highly detailed" selected>å¯«å¯¦ (Realistic)</option>
                <option value="Cinematic lighting, moody">é›»å½±æ„Ÿ (Cinematic)</option>
                <option value="Anime style, vibrant colors">å‹•æ¼« (Anime)</option>
                <option value="3D render, c4d, octane render">3D æ¸²æŸ“ (3D Render)</option>
                <option value="Black and white photography, noir">é»‘ç™½ (B&W)</option>
                <option value="SURPRISE_ME">ğŸ² Surprise me ! (éš¨æ©Ÿ)</option>
            </select>
        </div>
        <div class="control-group">
            <label>å ´æ™¯æè¿°</label>
            <textarea id="sceneDesc" rows="3" placeholder="ä¾‹å¦‚ï¼šä¸€ä½ç‰¹å‹™æ‹¿è‘—æ§..."></textarea>
        </div>
        <button id="resetBtn" class="toggle-btn" style="margin-bottom:10px; background:#444;">â†º é‡ç½®äººç‰©ä½ç½®</button>
        <button id="generateBtn" class="btn-primary">âœ¨ ç”Ÿæˆ Prompt</button>
        <div id="result-area">(ç­‰å¾…ç”Ÿæˆ...)</div>
        <button id="copyBtn" class="btn-copy">ğŸ“‹ è¤‡è£½</button>
    </div>

    <script>
        let camera, scene, renderer, controls;
        let dummyGroup, headMesh, armL, armR;
        let isPovMode = false;
        let currentLens = '1'; 
        let initialCamPos = new THREE.Vector3(0, 1.5, 3.5);
        
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a1a);
            scene.fog = new THREE.Fog(0x1a1a1a, 2, 20);

            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.01, 1000);
            camera.position.copy(initialCamPos);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            const ambientLight = new THREE.AmbientLight(0x404040, 1.5); scene.add(ambientLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 1.5); 
            dirLight.position.set(5, 10, 7); dirLight.castShadow = true; scene.add(dirLight);
            
            const gridHelper = new THREE.GridHelper(20, 20, 0x333333, 0x222222); scene.add(gridHelper);
            
            createDummy();

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.target.set(0, 1.2, 0);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            window.addEventListener('resize', onWindowResize, false);
            animate();
        }

        function createDummy() {
            dummyGroup = new THREE.Group();
            const skinMat = new THREE.MeshStandardMaterial({ color: 0xccaa88, roughness: 0.4 });
            
            headMesh = new THREE.Mesh(new THREE.SphereGeometry(0.25, 32, 32), skinMat);
            headMesh.position.y = 1.7; 
            headMesh.castShadow = true;
            
            const nose = new THREE.Mesh(new THREE.BoxGeometry(0.08, 0.08, 0.15), new THREE.MeshStandardMaterial({color: 0xff5555}));
            nose.position.set(0, 0, 0.25);
            headMesh.add(nose);
            dummyGroup.add(headMesh);

            const body = new THREE.Mesh(new THREE.CylinderGeometry(0.25, 0.2, 0.7, 32), skinMat);
            body.position.y = 1.15; body.castShadow = true;
            dummyGroup.add(body);

            const armGeo = new THREE.CylinderGeometry(0.08, 0.07, 0.75);
            armGeo.translate(0, -0.3, 0);

            armL = new THREE.Mesh(armGeo, skinMat);
            armL.position.set(0.35, 1.45, 0); 
            armL.rotation.z = -0.2; 
            dummyGroup.add(armL);

            armR = new THREE.Mesh(armGeo, skinMat);
            armR.position.set(-0.35, 1.45, 0); 
            armR.rotation.z = 0.2; 
            dummyGroup.add(armR);

            const legGeo = new THREE.CylinderGeometry(0.1, 0.08, 0.85);
            const legL = new THREE.Mesh(legGeo, skinMat); legL.position.set(0.15, 0.4, 0); dummyGroup.add(legL);
            const legR = new THREE.Mesh(legGeo, skinMat); legR.position.set(-0.15, 0.4, 0); dummyGroup.add(legR);

            scene.add(dummyGroup);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            updateFrameSize();
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        const lensBtns = document.querySelectorAll('.lens-btn');
        lensBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                lensBtns.forEach(b => { b.classList.remove('active'); b.classList.remove('macro-active'); });
                const target = e.currentTarget;
                target.classList.add('active');
                if(target.dataset.lens === 'macro') target.classList.add('macro-active');
                setLens(target.dataset.lens);
            });
        });

        function setLens(lensType) {
            currentLens = lensType;
            if (isPovMode && lensType !== '0.5') togglePOV(false); 

            switch(lensType) {
                case '0.5': camera.fov = 90; break;
                case '1': 
                    camera.fov = 50; 
                    if(controls.getDistance() < 1) controls.minDistance = 1.5; 
                    break;
                case '3': camera.fov = 25; break;
                case 'macro': 
                    camera.fov = 35;
                    const dir = new THREE.Vector3();
                    camera.getWorldDirection(dir);
                    const targetPos = controls.target.clone();
                    const newPos = targetPos.clone().add(dir.multiplyScalar(-0.5)); 
                    camera.position.copy(newPos);
                    break;
            }
            camera.updateProjectionMatrix();
        }

        const povBtn = document.getElementById('pov-toggle-btn');
        povBtn.addEventListener('click', () => togglePOV(!isPovMode));

        function togglePOV(enable) {
            isPovMode = enable;
            
            if (isPovMode) {
                povBtn.classList.add('active');
                povBtn.innerHTML = 'ğŸ§Ÿ';

                armL.rotation.x = -1.6; 
                armL.rotation.z = -0.5;
                armR.rotation.x = -1.6;
                armR.rotation.z = 0.5;

                headMesh.visible = false;

                document.querySelector('[data-lens="0.5"]').click();

                camera.position.set(0, 1.65, -0.1);
                controls.target.set(0, 1.65, 0.1); 
                
                controls.minAzimuthAngle = -0.8; 
                controls.maxAzimuthAngle = 0.8;
                controls.minPolarAngle = 1.2;    
                controls.maxPolarAngle = 1.9;    
                controls.update();

            } else {
                povBtn.classList.remove('active');
                povBtn.innerHTML = 'ğŸ”„';

                armL.rotation.x = 0;
                armL.rotation.z = -0.2;
                armR.rotation.x = 0;
                armR.rotation.z = 0.2;

                headMesh.visible = true;

                document.querySelector('[data-lens="1"]').click();

                camera.position.copy(initialCamPos);
                controls.target.set(0, 1.2, 0);

                controls.minAzimuthAngle = -Infinity;
                controls.maxAzimuthAngle = Infinity;
                controls.minPolarAngle = 0;
                controls.maxPolarAngle = Math.PI;
                controls.update();
            }
        }

        const uiPanel = document.getElementById('ui-panel');
        document.getElementById('open-menu-btn').addEventListener('click', () => uiPanel.classList.add('open'));
        document.getElementById('close-menu-btn').addEventListener('click', () => uiPanel.classList.remove('open'));

        const toggleGrid = document.getElementById('toggleGrid');
        const gridLayer = document.getElementById('grid-layer');
        let isGridOn = false;
        toggleGrid.addEventListener('click', () => {
            isGridOn = !isGridOn;
            gridLayer.style.display = isGridOn ? 'flex' : 'none';
            toggleGrid.classList.toggle('active', isGridOn);
        });

        const aspectFrame = document.getElementById('aspect-frame');
        const aspectRatioSel = document.getElementById('aspectRatio');
        aspectRatioSel.addEventListener('change', updateFrameSize);
        function updateFrameSize() {
            const ratioStr = aspectRatioSel.value;
            const parts = ratioStr.split(':');
            const ratioVal = parseFloat(parts[0]) / parseFloat(parts[1]);
            const margin = 20; 
            const maxW = window.innerWidth - margin;
            const maxH = window.innerHeight - margin; 
            let finalW = maxW;
            let finalH = finalW / ratioVal;
            if (finalH > maxH) { finalH = maxH; finalW = finalH * ratioVal; }
            aspectFrame.style.width = finalW + 'px';
            aspectFrame.style.height = finalH + 'px';
        }
        updateFrameSize();

        document.getElementById('resetBtn').addEventListener('click', () => {
            if(isPovMode) togglePOV(false); 
            camera.position.copy(initialCamPos);
            controls.target.set(0, 1.2, 0);
            controls.update();
            document.querySelector('[data-lens="1"]').click(); 
        });

        const hiddenStyles = ["Cyberpunk, neon", "Watercolor", "Claymation", "Ukiyo-e", "Pixel art", "Steampunk", "Synthwave", "Polaroid"];

        document.getElementById('generateBtn').addEventListener('click', () => {
            let style = document.getElementById('style').value;
            if (style.includes('SURPRISE')) style = hiddenStyles[Math.floor(Math.random() * hiddenStyles.length)];
            
            let lensPrompt = "";
            let shotType = "";
            
            switch(currentLens) {
                case '0.5':
                    // V13.2 ä¿®æ­£ï¼šç§»é™¤ distortionï¼ŒåŠ å…¥ Rectilinear å’Œ no vignetting
                    lensPrompt = "Wide angle lens, 16mm, Rectilinear lens, dynamic action, (no vignetting)";
                    break;
                case '1':
                    lensPrompt = "35mm lens, standard view, realistic proportion";
                    break;
                case '3':
                    lensPrompt = "Telephoto lens, 85mm, compressed background, bokeh, flattering portrait";
                    break;
                case 'macro':
                    lensPrompt = "Macro photography, 100mm macro lens, extreme close-up, detailed texture, shallow depth of field";
                    shotType = "Extreme Close-up";
                    break;
            }

            let povPrompt = "";
            if (isPovMode) {
                povPrompt = "(POV), (First Person Perspective), (view from eyes), visible hands, holding object, arms reaching out, immersive, FPS game style, ";
                shotType = "Point of View Shot"; 
            }

            if (!shotType) {
                const dist = camera.position.distanceTo(controls.target);
                if (dist < 1.5) shotType = "Close-up";
                else if (dist < 3.0) shotType = "Medium Shot";
                else if (dist < 6.0) shotType = "Full Body Shot";
                else shotType = "Wide Shot";
            }

            const hDiff = camera.position.y - controls.target.y;
            let angleType = "Eye-level";
            if (hDiff > 0.8) angleType = "High angle";
            else if (hDiff < -0.5) angleType = "Low angle";

            const userDesc = document.getElementById('sceneDesc').value.trim() || "character";
            const ratio = aspectRatioSel.value;
            
            const finalPrompt = `${povPrompt}${style}, ${userDesc}, ${shotType}, ${angleType}, ${lensPrompt}, (${ratio} aspect ratio), (best quality), (masterpiece)`;

            const resultArea = document.getElementById('result-area');
            resultArea.innerText = finalPrompt;

            const copyBtn = document.getElementById('copyBtn');
            copyBtn.style.display = 'block';
            copyBtn.innerText = 'ğŸ“‹ è¤‡è£½ Prompt';
            copyBtn.style.background = '#00e676';
        });

        const copyBtn = document.getElementById('copyBtn');
        copyBtn.addEventListener('click', () => {
            const text = document.getElementById('result-area').innerText;
            navigator.clipboard.writeText(text).then(() => {
                copyBtn.innerText = 'âœ… å·²è¤‡è£½ï¼'; 
                copyBtn.style.background = '#4caf50';
                setTimeout(() => { copyBtn.innerText = 'ğŸ“‹ è¤‡è£½'; copyBtn.style.background = '#00e676'; }, 2000);
            });
        });

        init();
    </script>
</body>
</html>
